!function(n,r,d){"use strict";function l(t){var e=t.getSelection().getSelectedElement();return o(t,e)?e:null}function o(t,e){var a=t.widgets.getByElement(e,!0);if(a&&"exoentity"===a.name)return a=n(e.$.firstChild).attr("data-embed-button"),a?t.config.ExoEntity_buttons.hasOwnProperty(a):void 0}function u(){return void 0===u.counter&&(u.counter=0),"entity-embed-"+u.counter++}d.plugins.add("exoentity",{requires:"widget",beforeInit:function(e){var t,a=d.dtd;for(t in a["drupal-entity"]={"#":1},a)a[t].div&&(a[t]["drupal-entity"]=1);if(e.addCommand("editexoentity",{allowedContent:"drupal-entity[data-embed-button,data-entity-type,data-entity-uuid,data-entity-embed-display,data-entity-embed-display-settings,data-align,data-caption]",requiredContent:"drupal-entity[data-embed-button,data-entity-type,data-entity-uuid,data-entity-embed-display,data-entity-embed-display-settings,data-align,data-caption]",modes:{wysiwyg:1},canUndo:!0,exec:function(n,t){t=t||{};var d=l(n),e={};if(d&&d.$&&d.$.firstChild)for(var a,i=d.$.firstChild,o=null,u=0;u<i.attributes.length;u++)"data-cke-saved-"!==(a=(o=i.attributes.item(u)).nodeName.toLowerCase()).substring(0,15)&&(e[a]=d.data("cke-saved-"+a)||o.nodeValue);t=t.id||e["data-embed-button"];r.ckeditor.openDialog(n,r.url("entity-embed/dialog/"+n.config.drupal.format+"/"+t),e,function(t){var e,a=n.document.createElement("drupal-entity"),i=t.attributes;for(e in i)a.setAttribute(e,i[e]);n.insertHtml(a.getOuterHtml()),d&&(r.runEmbedBehaviors("detach",d.$),d.remove())},{dialogClass:"entity-select-dialog",resizable:!1})}}),e.widgets.add("exoentity",{allowedContent:"drupal-entity[data-entity-type,data-entity-uuid,data-entity-embed-display,data-entity-embed-display-settings,data-align,data-caption]",requiredContent:"drupal-entity[data-entity-type,data-entity-uuid,data-entity-embed-display,data-entity-embed-display-settings,data-align,data-caption]",upcast:function(t){var e=t.attributes;if(!(void 0===e["data-entity-type"]||void 0===e["data-entity-id"]&&void 0===e["data-entity-uuid"]||void 0===e["data-view-mode"]&&void 0===e["data-entity-embed-display"]))return t.attributes.id=u(),t},init:function(){var t=this.element,t=r.ajax({base:t.getId(),element:t.$,url:r.url("embed/preview/"+e.config.drupal.format+"?"+n.param({value:t.getOuterHtml()})),progress:{type:"none"},event:"entity_embed_dummy_event"});t.options.headers={"X-Drupal-EmbedPreview-CSRF-Token":e.config.ExoEntity_previewCsrfToken},t.execute()},downcast:function(t){return t.setHtml(""),delete t.attributes.id,t}}),e.ui.addButton)for(var i in e.config.ExoEntity_buttons){i=e.config.ExoEntity_buttons[i];e.ui.addButton(i.id,{label:i.label,data:i,allowedContent:"drupal-entity[!data-entity-type,!data-entity-uuid,!data-entity-embed-display,!data-entity-embed-display-settings,!data-align,!data-caption,!data-embed-button]",click:function(t){t.execCommand("editexoentity",this.data)},icon:"_ exo-icon exo-icon-font icon-"+i.icon+"  _"})}e.contextMenu&&(e.addMenuGroup("exoentity"),e.addMenuItem("exoentity",{label:r.t("Edit Entity"),icon:this.path+"entity.png",command:"editexoentity",group:"exoentity"}),e.contextMenu.addListener(function(t){if(o(e,t))return{exoentity:d.TRISTATE_OFF}})),e.on("doubleclick",function(t){t=l(e)||t.data.element;o(e,t)&&e.execCommand("editexoentity")})}})}(jQuery,Drupal,CKEDITOR);